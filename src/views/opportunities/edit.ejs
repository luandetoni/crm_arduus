<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <!-- Google Fonts - Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Main CSS -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/images/favicon.png">
</head>
<body>
    <div class="dashboard">
        <%- include('../partials/sidebar') %>
        
        <div class="main-content">
            <%- include('../partials/header') %>
            
            <div class="content">
                <div class="d-flex align-center justify-between mb-20">
                    <h1 class="page-title">Editar Oportunidade</h1>
                    <div>
                        <a href="/opportunities/<%= opportunityId %>" class="btn btn-primary">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </a>
                    </div>
                </div>
                
                <form id="editOpportunityForm">
                    <div class="form-card">
                        <div class="form-section">
                            <h3 class="form-section-title">Informações Básicas</h3>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="title" class="form-label">Título *</label>
                                        <input type="text" id="title" name="title" class="form-control" required value="Renovação de contrato anual">
                                    </div>
                                </div>
                                
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="customer" class="form-label">Cliente *</label>
                                        <select id="customer" name="customer" class="form-control" required>
                                            <option value="">Selecione um cliente</option>
                                            <option value="1" selected>João Silva (Silva & Cia)</option>
                                            <option value="2">Ana Santos</option>
                                            <option value="3">Tech Solutions</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="value" class="form-label">Valor *</label>
                                        <input type="text" id="value" name="value" class="form-control" placeholder="R$ 0,00" required value="R$ 12.800,00">
                                    </div>
                                </div>
                                
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="stage" class="form-label">Estágio *</label>
                                        <select id="stage" name="stage" class="form-control" required>
                                            <option value="prospeccao">Prospecção</option>
                                            <option value="qualificacao">Qualificação</option>
                                            <option value="proposta" selected>Proposta</option>
                                            <option value="negociacao">Negociação</option>
                                            <option value="fechamento">Fechamento</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="probability" class="form-label">Probabilidade (%)</label>
                                        <input type="number" id="probability" name="probability" class="form-control" min="0" max="100" value="50">
                                    </div>
                                </div>
                                
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="expectedCloseDate" class="form-label">Data Prevista de Fechamento *</label>
                                        <input type="date" id="expectedCloseDate" name="expectedCloseDate" class="form-control" required value="2025-06-15">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3 class="form-section-title">Descrição & Detalhes</h3>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="description" class="form-label">Descrição</label>
                                        <textarea id="description" name="description" class="form-control" rows="4">Renovação do contrato de serviços de consultoria para o ano de 2025. Cliente mostrou interesse em manter os serviços atuais com pequenas alterações no escopo.</textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="source" class="form-label">Origem</label>
                                        <select id="source" name="source" class="form-control">
                                            <option value="indicacao" selected>Indicação</option>
                                            <option value="website">Website</option>
                                            <option value="midia_social">Mídia Social</option>
                                            <option value="ligacao_fria">Ligação fria</option>
                                            <option value="evento">Evento</option>
                                            <option value="parceiro">Parceiro</option>
                                            <option value="outro">Outro</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="assignedTo" class="form-label">Responsável</label>
                                        <select id="assignedTo" name="assignedTo" class="form-control">
                                            <option value="">Selecione um responsável</option>
                                            <option value="1" selected>Vendedor 1</option>
                                            <option value="2">Vendedor 2</option>
                                            <option value="3">Gerente de Vendas</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3 class="form-section-title">Produtos</h3>
                            
                            <div class="table-responsive mb-20">
                                <table class="table" id="productsTable">
                                    <thead>
                                        <tr>
                                            <th>Produto</th>
                                            <th>Preço Unitário</th>
                                            <th>Quantidade</th>
                                            <th>Desconto (%)</th>
                                            <th>Total</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="product-row">
                                            <td>
                                                <select name="products[0][product]" class="form-control product-select" required>
                                                    <option value="">Selecione um produto</option>
                                                    <option value="1" selected>Produto A</option>
                                                    <option value="2">Produto B</option>
                                                    <option value="3">Produto C</option>
                                                </select>
                                            </td>
                                            <td>
                                                <input type="text" name="products[0][price]" class="form-control product-price" value="R$ 5.000,00" readonly>
                                            </td>
                                            <td>
                                                <input type="number" name="products[0][quantity]" class="form-control product-quantity" value="2" min="1">
                                            </td>
                                            <td>
                                                <input type="number" name="products[0][discount]" class="form-control product-discount" value="10" min="0" max="100">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control product-total" value="R$ 9.000,00" readonly>
                                            </td>
                                            <td>
                                                <button type="button" class="btn-icon remove-product"><i class="fas fa-trash"></i></button>
                                            </td>
                                        </tr>
                                        <tr class="product-row">
                                            <td>
                                                <select name="products[1][product]" class="form-control product-select" required>
                                                    <option value="">Selecione um produto</option>
                                                    <option value="1">Produto A</option>
                                                    <option value="2" selected>Produto B</option>
                                                    <option value="3">Produto C</option>
                                                </select>
                                            </td>
                                            <td>
                                                <input type="text" name="products[1][price]" class="form-control product-price" value="R$ 1.900,00" readonly>
                                            </td>
                                            <td>
                                                <input type="number" name="products[1][quantity]" class="form-control product-quantity" value="2" min="1">
                                            </td>
                                            <td>
                                                <input type="number" name="products[1][discount]" class="form-control product-discount" value="5" min="0" max="100">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control product-total" value="R$ 3.800,00" readonly>
                                            </td>
                                            <td>
                                                <button type="button" class="btn-icon remove-product"><i class="fas fa-trash"></i></button>
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="4" class="text-right"><strong>Subtotal:</strong></td>
                                            <td>R$ 13.800,00</td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td colspan="4" class="text-right"><strong>Desconto Total:</strong></td>
                                            <td>R$ 1.000,00</td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td colspan="4" class="text-right"><strong>Total:</strong></td>
                                            <td>R$ 12.800,00</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            
                            <button type="button" id="addProductBtn" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Adicionar Produto
                            </button>
                        </div>
                        
                        <div class="form-section">
                            <h3 class="form-section-title">Concorrentes</h3>
                            
                            <div id="competitorsContainer">
                                <div class="competitor-item mb-15">
                                    <div class="form-row">
                                        <div class="form-col">
                                            <div class="form-group">
                                                <label class="form-label">Nome da Empresa</label>
                                                <input type="text" name="competitors[0][name]" class="form-control" value="Concorrente XYZ">
                                            </div>
                                        </div>
                                        <div class="form-col">
                                            <div class="form-group">
                                                <label class="form-label">Força</label>
                                                <select name="competitors[0][strength]" class="form-control">
                                                    <option value="low">Baixa</option>
                                                    <option value="medium" selected>Média</option>
                                                    <option value="high">Alta</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-col" style="flex: 0 0 50px; align-self: flex-end;">
                                            <div class="form-group">
                                                <label class="form-label">&nbsp;</label>
                                                <button type="button" class="btn-icon remove-competitor"><i class="fas fa-trash"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="button" id="addCompetitorBtn" class="btn btn-primary mt-10">
                                <i class="fas fa-plus"></i> Adicionar Concorrente
                            </button>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="window.location.href='/opportunities/<%= opportunityId %>'">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Template para linha de produto -->
    <template id="productRowTemplate">
        <tr class="product-row">
            <td>
                <select name="products[{index}][product]" class="form-control product-select" required>
                    <option value="">Selecione um produto</option>
                    <option value="1">Produto A</option>
                    <option value="2">Produto B</option>
                    <option value="3">Produto C</option>
                </select>
            </td>
            <td>
                <input type="text" name="products[{index}][price]" class="form-control product-price" placeholder="R$ 0,00" readonly>
            </td>
            <td>
                <input type="number" name="products[{index}][quantity]" class="form-control product-quantity" value="1" min="1">
            </td>
            <td>
                <input type="number" name="products[{index}][discount]" class="form-control product-discount" value="0" min="0" max="100">
            </td>
            <td>
                <input type="text" class="form-control product-total" value="R$ 0,00" readonly>
            </td>
            <td>
                <button type="button" class="btn-icon remove-product"><i class="fas fa-trash"></i></button>
            </td>
        </tr>
    </template>

    <!-- Template para concorrente -->
    <template id="competitorTemplate">
        <div class="competitor-item mb-15">
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label class="form-label">Nome da Empresa</label>
                        <input type="text" name="competitors[{index}][name]" class="form-control">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label class="form-label">Força</label>
                        <select name="competitors[{index}][strength]" class="form-control">
                            <option value="low">Baixa</option>
                            <option value="medium">Média</option>
                            <option value="high">Alta</option>
                        </select>
                    </div>
                </div>
                <div class="form-col" style="flex: 0 0 50px; align-self: flex-end;">
                    <div class="form-group">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn-icon remove-competitor"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- jQuery (necessário para alguns plugins Bootstrap) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Main JavaScript -->
    <script src="/js/main.js"></script>
    <script>
        // Script específico para formulário de edição de oportunidade
        $(document).ready(function() {
            // Atualizar estágio baseado na probabilidade
            $('#probability').on('input', function() {
                const probability = parseInt($(this).val());
                
                if (probability < 20) {
                    $('#stage').val('prospeccao');
                } else if (probability < 40) {
                    $('#stage').val('qualificacao');
                } else if (probability < 60) {
                    $('#stage').val('proposta');
                } else if (probability < 80) {
                    $('#stage').val('negociacao');
                } else {
                    $('#stage').val('fechamento');
                }
            });
            
            // Atualizar probabilidade baseado no estágio
            $('#stage').change(function() {
                const stage = $(this).val();
                let probability = 50;
                
                switch(stage) {
                    case 'prospeccao':
                        probability = 10;
                        break;
                    case 'qualificacao':
                        probability = 30;
                        break;
                    case 'proposta':
                        probability = 50;
                        break;
                    case 'negociacao':
                        probability = 70;
                        break;
                    case 'fechamento':
                        probability = 90;
                        break;
                }
                
                $('#probability').val(probability);
            });
            
            // Formatação de moeda para o campo valor
            $('#value').on('input', function() {
                let value = $(this).val().replace(/\D/g, '');
                if (value === '') return;
                
                value = parseInt(value);
                $(this).val(formatCurrency(value / 100));
            });
            
            // Adicionar produto
            let productIndex = 2; // Já temos 2 produtos adicionados
            
            $('#addProductBtn').click(function() {
                addProductRow();
            });
            
            function addProductRow() {
                const template = $('#productRowTemplate').html();
                const newRow = template.replace(/{index}/g, productIndex);
                
                $('#productsTable tbody').append(newRow);
                
                // Event listeners para a nova linha
                const $newRow = $('#productsTable tbody tr').last();
                
                $newRow.find('.product-select').change(function() {
                    const productId = $(this).val();
                    if (!productId) return;
                    
                    // Simulação - em produção você buscaria esses dados do servidor
                    const prices = {
                        '1': 5000,
                        '2': 1900,
                        '3': 2500
                    };
                    
                    const price = prices[productId] || 0;
                    $(this).closest('tr').find('.product-price').val(formatCurrency(price));
                    
                    updateProductTotal($(this).closest('tr'));
                    updateTotals();
                });
                
                $newRow.find('.product-quantity, .product-discount').on('input', function() {
                    updateProductTotal($(this).closest('tr'));
                    updateTotals();
                });
                
                $newRow.find('.remove-product').click(function() {
                    $(this).closest('tr').remove();
                    updateTotals();
                });
                
                productIndex++;
            }
            
            // Adicionar event listeners para linhas existentes
            $('.product-select').change(function() {
                const productId = $(this).val();
                if (!productId) return;
                
                const prices = {
                    '1': 5000,
                    '2': 1900,
                    '3': 2500
                };
                
                const price = prices[productId] || 0;
                $(this).closest('tr').find('.product-price').val(formatCurrency(price));
                
                updateProductTotal($(this).closest('tr'));
                updateTotals();
            });
            
            $('.product-quantity, .product-discount').on('input', function() {
                updateProductTotal($(this).closest('tr'));
                updateTotals();
            });
            
            $('.remove-product').click(function() {
                $(this).closest('tr').remove();
                updateTotals();
            });
            
            function updateProductTotal($row) {
                const priceText = $row.find('.product-price').val();
                const price = parseCurrency(priceText);
                const quantity = parseInt($row.find('.product-quantity').val()) || 0;
                const discount = parseInt($row.find('.product-discount').val()) || 0;
                
                const total = price * quantity * (1 - discount / 100);
                $row.find('.product-total').val(formatCurrency(total));
            }
            
            function updateTotals() {
                let subtotal = 0;
                let totalDiscount = 0;
                
                $('#productsTable tbody tr').each(function() {
                    const priceText = $(this).find('.product-price').val();
                    const price = parseCurrency(priceText);
                    const quantity = parseInt($(this).find('.product-quantity').val()) || 0;
                    const discount = parseInt($(this).find('.product-discount').val()) || 0;
                    
                    const rowSubtotal = price * quantity;
                    const rowDiscount = rowSubtotal * (discount / 100);
                    
                    subtotal += rowSubtotal;
                    totalDiscount += rowDiscount;
                });
                
                const total = subtotal - totalDiscount;
                
                $('#productsTable tfoot tr:eq(0) td:eq(1)').text(formatCurrency(subtotal));
                $('#productsTable tfoot tr:eq(1) td:eq(1)').text(formatCurrency(totalDiscount));
                $('#productsTable tfoot tr:eq(2) td:eq(1)').text(formatCurrency(total));
                
                // Atualiza o campo valor com o total
                $('#value').val(formatCurrency(total));
            }
            
            // Adicionar concorrente
            let competitorIndex = 1; // Já temos 1 concorrente adicionado
            
            $('#addCompetitorBtn').click(function() {
                addCompetitor();
            });
            
            function addCompetitor() {
                const template = $('#competitorTemplate').html();
                const newCompetitor = template.replace(/{index}/g, competitorIndex);
                
                $('#competitorsContainer').append(newCompetitor);
                
                // Event listener para remover
                $('#competitorsContainer .competitor-item').last().find('.remove-competitor').click(function() {
                    $(this).closest('.competitor-item').remove();
                });
                
                competitorIndex++;
            }
            
            // Event listener para botões de remover concorrente existentes
            $('.remove-competitor').click(function() {
                $(this).closest('.competitor-item').remove();
            });
            
            // Parse de string de moeda para número
            function parseCurrency(value) {
                return parseFloat(value.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
            }
            
            // Formatar número como moeda
            function formatCurrency(value) {
                return 'R$ ' + value.toFixed(2).replace('.', ',').replace(/(\d)(?=(\d{3})+,)/g, '$1.');
            }
            
            // Submit form
            $('#editOpportunityForm').submit(function(e) {
                e.preventDefault();
                
                // Coleta dados do formulário
                const formData = {};
                $(this).serializeArray().forEach(item => {
                    if (item.name.includes('[')) {
                        // Handle array fields (products, competitors)
                        const matches = item.name.match(/([a-z]+)\[([0-9]+)\]\[([a-z]+)\]/);
                        if (matches) {
                            const [, arrayName, index, property] = matches;
                            
                            if (!formData[arrayName]) {
                                formData[arrayName] = [];
                            }
                            
                            if (!formData[arrayName][index]) {
                                formData[arrayName][index] = {};
                            }
                            
                            formData[arrayName][index][property] = item.value;
                        }
                    } else {
                        formData[item.name] = item.value;
                    }
                });
                
                // Clean up arrays (convert from object with numeric keys to actual array)
                if (formData.products) {
                    formData.products = Object.values(formData.products);
                }
                
                if (formData.competitors) {
                    formData.competitors = Object.values(formData.competitors);
                }
                
                console.log('Dados da oportunidade:', formData);
                
                // Em uma aplicação real, você faria:
                // updateOpportunity(<%= opportunityId %>, formData)
                //    .then(response => {
                //        window.location.href = `/opportunities/${response._id}`;
                //    })
                //    .catch(error => {
                //        console.error('Erro ao atualizar oportunidade:', error);
                //        showNotification('Erro ao atualizar oportunidade', 'error');
                //    });
                
                // Por enquanto, redirecionamos para a página de detalhes
                setTimeout(() => {
                    window.location.href = '/opportunities/<%= opportunityId %>';
                }, 1000);
                
                alert('Oportunidade atualizada com sucesso!');
            });
        });
    </script>
</body>
</html>